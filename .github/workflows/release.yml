name: Release
on:
  schedule:
    - cron: "00 21 * * *"
  repository_dispatch:
    types: manual_release
  workflow_dispatch:

permissions:
  id-token: write    # Requis pour OIDC / npm trusted publishing
  contents: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.x
          registry-url: https://registry.npmjs.org

      - name: Update npm (required for npm trusted publishing)
        run: npm install -g npm@latest

      - name: Get yarn cache directory path
        id: init
        shell: bash
        run: |
          echo "yarn_cache=$(yarn cache dir)" >> "$GITHUB_OUTPUT"
          echo "Node $(node --version)"
          echo "Yarn $(yarn --version)"
          echo "Npm $(npm --version)"

      - uses: actions/checkout@v4

      - name: Cache Yarn packages
        id: yarn_cache_packages
        uses: actions/cache@v4
        with:
          path: ${{ steps.init.outputs.yarn_cache }}
          key: ${{ runner.os }}-yarn_cache-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn_cache-

      - name: Installing
        run: yarn --frozen-lockfile --link-duplicates --prefer-offline

      - name: Build
        run: yarn build

      - name: Log npm environment
        run: |
          echo "Node version:"
          node --version
          echo "NPM version:"
          npm --version
          echo "NPM registry:"
          npm config get registry
          echo "NPM user (si connecté) :"
          npm whoami || echo "Non connecté à npm (whoami a échoué)"
          echo $NPM_TOKEN

      - name: Publish NPM package
        run: npm publish --loglevel verbose
